{% extends 'base.html' %}

{% block title %}Analysis{% endblock %}

{% block extra_css %}
<style>
    .filter-card {
        position: sticky;
        top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Store the JSON data in hidden elements to access them in JavaScript -->
<script type="application/json" id="spend-category-data">{{ spend_category_data|safe }}</script>
<script type="application/json" id="investment-category-data">{{ investment_category_data|safe }}</script>
<script type="application/json" id="savings-category-data">{{ savings_category_data|safe }}</script>
<script type="application/json" id="monthly-trends">{{ monthly_trends|safe }}</script>
<script type="application/json" id="yearly-trends">{{ yearly_trends|safe }}</script>

<div class="row mb-4">
    <div class="col">
        <h2 class="display-6 fw-bold"><i class="fas fa-chart-line me-2"></i>Financial Analysis</h2>
        <p class="text-muted">Analyze your spending patterns and financial trends</p>
    </div>
</div>

<div class="row g-4">
    <!-- Filter Panel -->
    <div class="col-lg-3">
        <div class="card shadow-sm filter-card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
            </div>
            <div class="card-body">
                <form id="filter-form">
                    <!-- Date Range -->
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="start-date" name="start_date">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="end-date" name="end_date">
                        </div>
                    </div>
                    
                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">All Categories</option>
                            {% for category in settings.categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Type -->
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" name="type">
                            <option value="">All Types</option>
                            <option value="Earning">Earning</option>
                            <option value="Spend">Spend</option>
                            <option value="Investment">Investment</option>
                            <option value="Savings">Savings</option>
                        </select>
                    </div>
                    
                    <!-- Preset Periods -->
                    <div class="mb-3">
                        <label class="form-label">Quick Period</label>
                        <div class="d-grid gap-2">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary period-btn" data-period="month">This Month</button>
                                <button type="button" class="btn btn-outline-primary period-btn" data-period="quarter">This Quarter</button>
                                <button type="button" class="btn btn-outline-primary period-btn" data-period="year">This Year</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Charts and Analysis -->
    <div class="col-lg-9">
        <!-- Monthly Trend Charts -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex align-items-center justify-content-between">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Monthly Trends</h5>
                <div class="d-flex align-items-center gap-2">
                    <label class="text-muted me-1 mb-0" for="monthlyChartType" style="font-size:.85rem;">View</label>
                    <select id="monthlyChartType" class="form-select form-select-sm w-auto">
                        <option value="bar" selected>Bar + Savings Line</option>
                        <option value="stacked">Stacked Bars</option>
                        <option value="line">Line</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <canvas id="monthlyTrendChart" height="250"></canvas>
            </div>
        </div>
        
        <!-- Category Breakdown -->
        <div class="row g-4 mb-4">
            <!-- Spend by Category -->
            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0"><i class="fas fa-chart-pie me-2"></i>Spend by Category</h5>
                        <select class="form-select form-select-sm w-auto chart-shape" data-target="spendCategoryPieChart">
                            <option value="pie">Pie</option>
                            <option value="doughnut" selected>Doughnut</option>
                        </select>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="spendCategoryPieChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Savings by Category -->
            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0"><i class="fas fa-piggy-bank me-2"></i>Savings by Category</h5>
                        <select class="form-select form-select-sm w-auto chart-shape" data-target="savingsCategoryPieChart">
                            <option value="pie">Pie</option>
                            <option value="doughnut" selected>Doughnut</option>
                        </select>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="savingsCategoryPieChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Investment by Category -->
            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-light d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Investment by Category</h5>
                        <select class="form-select form-select-sm w-auto chart-shape" data-target="investmentCategoryPieChart">
                            <option value="pie">Pie</option>
                            <option value="doughnut" selected>Doughnut</option>
                        </select>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="investmentCategoryPieChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trends -->
        <div class="row g-4">
            <!-- Yearly Trend Chart -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Yearly Trends</h5>
                        <div class="d-flex align-items-center gap-2">
                            <label class="text-muted me-1 mb-0" for="yearlyChartType" style="font-size:.85rem;">View</label>
                            <select id="yearlyChartType" class="form-select form-select-sm w-auto">
                                <option value="line" selected>Line</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="yearlyTrendChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initial aggregated data from server
        let spendCategoryData = JSON.parse(document.getElementById('spend-category-data').textContent || '{}');
        let investmentCategoryData = JSON.parse(document.getElementById('investment-category-data').textContent || '{}');
        let savingsCategoryData = JSON.parse(document.getElementById('savings-category-data').textContent || '{}');
        let monthlyTrends = JSON.parse(document.getElementById('monthly-trends').textContent || '{}');
        let yearlyTrends = JSON.parse(document.getElementById('yearly-trends').textContent || '{}');

        const charts = { spend: null, save: null, invest: null, monthly: null, yearly: null };

        // Helper: colors
        function generateColors(count) {
            const colors = [
                '#4dc9f6', '#f67019', '#f53794', '#537bc4', '#acc236', '#166a8f',
                '#00a950', '#58595b', '#8549ba', '#e6194b', '#3cb44b', '#ffe119',
                '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c',
                '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000'
            ];
            if (count > colors.length) {
                const out = [];
                while (out.length < count) out.push(...colors);
                return out.slice(0, count);
            }
            return colors.slice(0, count);
        }

        // Helper: create/update pie/doughnut
        function upsertPie(canvasId, data, mode) {
            const labels = Object.keys(data || {});
            const values = Object.values(data || {});
            const colors = generateColors(labels.length);
            const ctx = document.getElementById(canvasId).getContext('2d');
            const makeConfig = () => ({
                type: mode || 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 1 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = (context.dataset.data || []).reduce((a, b) => a + b, 0);
                                    const pct = total > 0 ? ((value * 100) / total).toFixed(1) : 0;
                                    return `${label}: ₹${Number(value).toLocaleString()} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
            // Destroy existing instance bound to canvas to switch types safely
            if (charts[canvasId]) { charts[canvasId].destroy(); }
            const chart = new Chart(ctx, makeConfig());
            charts[canvasId] = chart;
            return chart;
        }

        // Helper: build datasets for monthly chart based on view type
        function buildMonthlyDatasets(labels, dataByMonth, view) {
            const earnings = labels.map(m => (dataByMonth[m]?.['Earning'] || 0));
            const spends = labels.map(m => (dataByMonth[m]?.['Spend'] || 0));
            const invests = labels.map(m => (dataByMonth[m]?.['Investment'] || 0));
            const savings = labels.map(m => (dataByMonth[m]?.['Savings'] || 0));
            const commonBar = { borderWidth: 1 };
            const asLine = (label, data, color, w=2) => ({ type: 'line', label, data, backgroundColor: color.replace('1)', '0.2)'), borderColor: color, borderWidth: w, tension: 0.3, pointRadius: 3, fill: true });
            const asBar = (label, data, color) => ({ type: 'bar', label, data, backgroundColor: color.replace('1)', '0.7)'), borderColor: color, ...commonBar });
            if (view === 'line') {
                return [
                    asLine('Earnings', earnings, 'rgba(40, 167, 69, 1)'),
                    asLine('Spends', spends, 'rgba(220, 53, 69, 1)'),
                    asLine('Investments', invests, 'rgba(23, 162, 184, 1)'),
                    asLine('Savings', savings, 'rgba(0, 123, 255, 1)', 3),
                ];
            }
            const ds = [
                asBar('Earnings', earnings, 'rgba(40, 167, 69, 1)'),
                asBar('Spends', spends, 'rgba(220, 53, 69, 1)'),
                asBar('Investments', invests, 'rgba(23, 162, 184, 1)')
            ];
            if (view === 'stacked') {
                ds.push(asBar('Savings', savings, 'rgba(0, 123, 255, 1)'));
            } else {
                ds.push(asLine('Savings', savings, 'rgba(0, 123, 255, 1)', 3));
            }
            return ds;
        }

        function upsertMonthly(view) {
            const monthKeys = Object.keys(monthlyTrends || {}).sort();
            const labels = monthKeys.map(m => {
                const [y, mo] = m.split('-');
                return new Date(y, Number(mo) - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            const datasets = buildMonthlyDatasets(monthKeys, monthlyTrends, view);
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            const stacked = (view === 'stacked');
            const config = {
                type: stacked ? 'bar' : (view === 'line' ? 'line' : 'bar'),
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked },
                        y: { beginAtZero: true, stacked, ticks: { callback: v => '₹' + Number(v).toLocaleString() } }
                    },
                    plugins: { tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ₹${Number(ctx.parsed.y ?? ctx.raw).toLocaleString()}` } } }
                }
            };
            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(ctx, config);
            return charts.monthly;
        }

        function upsertYearly(view) {
            const years = Object.keys(yearlyTrends || {}).sort();
            const get = (t) => years.map(y => yearlyTrends[y]?.[t] || 0);
            const datasets = [
                { label: 'Earnings', data: get('Earning'), backgroundColor: 'rgba(40,167,69,0.2)', borderColor: 'rgba(40,167,69,1)', borderWidth: 2, tension: 0.3, fill: true },
                { label: 'Spends', data: get('Spend'), backgroundColor: 'rgba(220,53,69,0.2)', borderColor: 'rgba(220,53,69,1)', borderWidth: 2, tension: 0.3, fill: true },
                { label: 'Investments', data: get('Investment'), backgroundColor: 'rgba(23,162,184,0.2)', borderColor: 'rgba(23,162,184,1)', borderWidth: 2, tension: 0.3, fill: true },
                { label: 'Savings', data: get('Savings'), backgroundColor: 'rgba(0,123,255,0.2)', borderColor: 'rgba(0,123,255,1)', borderWidth: 3, tension: 0.3, fill: true }
            ].map(ds => (view === 'bar' ? { ...ds, type: 'bar', backgroundColor: ds.borderColor.replace('1)', '0.7)') } : { ...ds, type: 'line' }));
            const ctx = document.getElementById('yearlyTrendChart').getContext('2d');
            const config = {
                type: view === 'bar' ? 'bar' : 'line',
                data: { labels: years, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: v => '₹' + Number(v).toLocaleString() } } },
                    plugins: { tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ₹${Number(ctx.parsed.y ?? ctx.raw).toLocaleString()}` } } }
                }
            };
            if (charts.yearly) charts.yearly.destroy();
            charts.yearly = new Chart(ctx, config);
            return charts.yearly;
        }

        // Initial render
        upsertPie('spendCategoryPieChart', spendCategoryData, 'doughnut');
        upsertPie('savingsCategoryPieChart', savingsCategoryData, 'doughnut');
        upsertPie('investmentCategoryPieChart', investmentCategoryData, 'doughnut');
        upsertMonthly(document.getElementById('monthlyChartType').value || 'bar');
        upsertYearly(document.getElementById('yearlyChartType').value || 'line');

        // Handlers: change shapes for pie/doughnut
        document.querySelectorAll('.chart-shape').forEach(sel => {
            sel.addEventListener('change', () => {
                const target = sel.getAttribute('data-target');
                const mode = sel.value;
                const dataMap = {
                    'spendCategoryPieChart': spendCategoryData,
                    'savingsCategoryPieChart': savingsCategoryData,
                    'investmentCategoryPieChart': investmentCategoryData
                };
                upsertPie(target, dataMap[target], mode);
            });
        });

        // Handlers: monthly/yearly chart type
        document.getElementById('monthlyChartType').addEventListener('change', (e) => upsertMonthly(e.target.value));
        document.getElementById('yearlyChartType').addEventListener('change', (e) => upsertYearly(e.target.value));

        // Period quick buttons
        document.querySelectorAll('.period-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const now = new Date();
                const endDate = now.toISOString().slice(0, 10);
                let startDate;
                switch(this.dataset.period) {
                    case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10); break;
                    case 'quarter': const qm = Math.floor(now.getMonth() / 3) * 3; startDate = new Date(now.getFullYear(), qm, 1).toISOString().slice(0, 10); break;
                    case 'year': startDate = new Date(now.getFullYear(), 0, 1).toISOString().slice(0, 10); break;
                }
                document.getElementById('start-date').value = startDate;
                document.getElementById('end-date').value = endDate;
            });
        });

        // Filters -> fetch -> aggregate -> update charts
        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const params = new URLSearchParams();
            const start = document.getElementById('start-date').value; if (start) params.append('start_date', start);
            const end = document.getElementById('end-date').value; if (end) params.append('end_date', end);
            const cat = document.getElementById('category').value; if (cat) params.append('category', cat);
            const typ = document.getElementById('type').value; if (typ) params.append('type', typ);

            fetch(`/api/expenses?${params.toString()}`, { credentials: 'same-origin' })
                .then(res => res.json())
                .then(rows => {
                    const recs = Array.isArray(rows) ? rows : [];
                    // Aggregate
                    const agg = aggregate(recs);
                    spendCategoryData = agg.spendCategory;
                    investmentCategoryData = agg.investCategory;
                    savingsCategoryData = agg.savingsCategory;
                    monthlyTrends = agg.monthly;
                    yearlyTrends = agg.yearly;

                    // Re-render charts keeping chosen views
                    upsertPie('spendCategoryPieChart', spendCategoryData, document.querySelector('[data-target="spendCategoryPieChart"]').value);
                    upsertPie('savingsCategoryPieChart', savingsCategoryData, document.querySelector('[data-target="savingsCategoryPieChart"]').value);
                    upsertPie('investmentCategoryPieChart', investmentCategoryData, document.querySelector('[data-target="investmentCategoryPieChart"]').value);
                    upsertMonthly(document.getElementById('monthlyChartType').value);
                    upsertYearly(document.getElementById('yearlyChartType').value);
                })
                .catch(err => {
                    console.error('Filter fetch failed', err);
                });
        });

        function aggregate(records) {
            const spendCategory = {};
            const investCategory = {};
            const savingsCategory = {};
            const monthly = {}; // key: YYYY-MM -> {type: sum}
            const yearly = {}; // key: YYYY -> {type: sum}
            for (const r of records) {
                const t = r.type; const cat = r.category; const amt = Number(r.amount) || 0;
                const d = new Date(r.date);
                if (!isFinite(d)) continue;
                const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                const yr = String(d.getFullYear());
                monthly[ym] = monthly[ym] || {}; yearly[yr] = yearly[yr] || {};
                monthly[ym][t] = (monthly[ym][t] || 0) + amt; yearly[yr][t] = (yearly[yr][t] || 0) + amt;
                if (t === 'Spend') { spendCategory[cat] = (spendCategory[cat] || 0) + amt; }
                if (t === 'Investment') { investCategory[cat] = (investCategory[cat] || 0) + amt; }
                if (t === 'Savings') { savingsCategory[cat] = (savingsCategory[cat] || 0) + amt; }
            }
            return { spendCategory, investCategory, savingsCategory, monthly, yearly };
        }
    });
</script>
{% endblock %}