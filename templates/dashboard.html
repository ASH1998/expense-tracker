{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="display-6 fw-bold"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
        <p class="text-muted">Overview of your financial situation</p>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-4 mb-4">
    <!-- Earnings Card -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-success text-white shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Total Earnings</h6>
                    <div class="icon-bg rounded-circle d-flex align-items-center justify-content-center">
                        <i class="fas fa-coins fa-lg"></i>
                    </div>
                </div>
                <h3 class="card-text fw-bold">₹{{ "{:,.2f}".format(earnings) }}</h3>
                <p class="card-text text-white-50 mt-auto"><small>All time earnings</small></p>
            </div>
        </div>
    </div>
    
    <!-- Spends Card -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-danger text-white shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Total Spends</h6>
                    <div class="icon-bg rounded-circle d-flex align-items-center justify-content-center">
                        <i class="fas fa-shopping-cart fa-lg"></i>
                    </div>
                </div>
                <h3 class="card-text fw-bold">₹{{ "{:,.2f}".format(spends) }}</h3>
                <p class="card-text text-white-50 mt-auto"><small>All time expenses</small></p>
            </div>
        </div>
    </div>
    
    <!-- Investments Card -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-info text-white shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Total Investments</h6>
                    <div class="icon-bg rounded-circle d-flex align-items-center justify-content-center">
                        <i class="fas fa-chart-line fa-lg"></i>
                    </div>
                </div>
                <h3 class="card-text fw-bold">₹{{ "{:,.2f}".format(investments) }}</h3>
                <p class="card-text text-white-50 mt-auto"><small>All time investments</small></p>
            </div>
        </div>
    </div>
    
    <!-- Savings Card -->
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-primary text-white shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Total Savings</h6>
                    <div class="icon-bg rounded-circle d-flex align-items-center justify-content-center">
                        <i class="fas fa-piggy-bank fa-lg"></i>
                    </div>
                </div>
                <h3 class="card-text fw-bold">₹{{ "{:,.2f}".format(savings) }}</h3>
                <p class="card-text text-white-50 mt-auto"><small>Earnings - Spends - Investments</small></p>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Cards -->
<div class="row g-4 mb-4" id="monthly-cards-row">
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-success text-white shadow-sm h-100" style="background-color: #4caf50 !important;">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">Earnings (Month)</h6>
                </div>
                <h4 class="card-text fw-bold mt-2" id="monthly-earning">₹0.00</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-danger text-white shadow-sm h-100" style="background-color: #f44336 !important;">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">Spends (Month)</h6>
                </div>
                <h4 class="card-text fw-bold mt-2" id="monthly-spend">₹0.00</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-info text-white shadow-sm h-100" style="background-color: #00bcd4 !important;">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">Investments (Month)</h6>
                </div>
                <h4 class="card-text fw-bold mt-2" id="monthly-investment">₹0.00</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card border-0 bg-primary text-white shadow-sm h-100" style="background-color: #2196f3 !important;">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">Savings (Month)</h6>
                </div>
                <h4 class="card-text fw-bold mt-2" id="monthly-savings">₹0.00</h4>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Recent Transactions -->
<div class="row g-4">
    <!-- Monthly Breakdown Chart -->
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Monthly Overview</h5>
                <div class="d-flex align-items-center gap-2">
                    <div class="input-group input-group-sm" style="width:auto;">
                        <select id="year-select" class="form-select bg-body text-body border-secondary"></select>
                        <select id="month-select" class="form-select bg-body text-body border-secondary ms-1"></select>
                    </div>
                    <div class="btn-group btn-group-sm ms-2">
                        <button type="button" class="btn btn-outline-primary active" data-chart-period="monthly">Monthly</button>
                        <button type="button" class="btn btn-outline-primary" data-chart-period="yearly">Yearly</button>
                        <button type="button" class="btn btn-outline-primary" data-chart-period="all">All</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Latest Transactions</h5>
                <a href="{{ url_for('manage_expenses') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>Add New
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if latest_records %}
                                {% for record in latest_records %}
                                <tr>
                                    <td>
                                        {% if record.date is string %}
                                            {{ record.date }}
                                        {% else %}
                                            {{ record.date.strftime('%d %b, %Y') }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.type == 'Earning' %}
                                            <span class="badge bg-success">{{ record.type }}</span>
                                        {% elif record.type == 'Spend' %}
                                            <span class="badge bg-danger">{{ record.type }}</span>
                                        {% elif record.type == 'Investment' %}
                                            <span class="badge bg-info">{{ record.type }}</span>
                                        {% endif %}
                                        <small class="d-block text-muted">{{ record.category }}</small>
                                    </td>
                                    <td class="fw-bold {% if record.type == 'Earning' %}text-success{% elif record.type == 'Spend' %}text-danger{% elif record.type == 'Investment' %}text-info{% endif %}">
                                        {% if record.type == 'Earning' %}+{% elif record.type == 'Spend' %}-{% endif %}₹{{ "{:,.2f}".format(record.amount) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" class="text-center py-4">No transactions found</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light text-center">
                <a href="{{ url_for('manage_expenses') }}" class="text-decoration-none">View All Transactions</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const monthlyData = JSON.parse('{{ monthly_data|safe }}');
        let allMonths = Object.keys(Object.values(monthlyData)[0] || {}).sort();
        let allYears = Array.from(new Set(allMonths.map(m => m.split('-')[0]))).sort();

        const MONTH_NAMES = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');

        function populateYearSelect() {
            yearSelect.innerHTML = '';
            allYears.forEach(year => {
                const opt = document.createElement('option');
                opt.value = year;
                opt.textContent = year;
                yearSelect.appendChild(opt);
            });
        }

        function populateMonthSelect(selectedYear) {
            monthSelect.innerHTML = '';
            const monthsForYear = allMonths
                .filter(m => m.startsWith(selectedYear + '-'))
                .map(m => m.split('-')[1]);
            const uniqueMonths = Array.from(new Set(monthsForYear)).sort();
            uniqueMonths.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = MONTH_NAMES[parseInt(m, 10) - 1];
                monthSelect.appendChild(opt);
            });
        }

        function getMonthLabel(ym) {
            const [year, monthNum] = ym.split('-');
            return MONTH_NAMES[parseInt(monthNum, 10) - 1] + ' ' + year;
        }
        function getSingleMonthChartData(year, month) {
            const ym = year + '-' + month;
            return {
                labels: [getMonthLabel(ym)],
                earnings: [monthlyData.Earning[ym] || 0],
                spends: [monthlyData.Spend[ym] || 0],
                investments: [monthlyData.Investment[ym] || 0],
                savings: [(monthlyData.Earning[ym] || 0) - (monthlyData.Spend[ym] || 0) - (monthlyData.Investment[ym] || 0)]
            };
        }
        function getSingleYearChartData(year) {
            let earnings = 0, spends = 0, investments = 0;
            allMonths.forEach(ym => {
                if (ym.startsWith(year + '-')) {
                    earnings += monthlyData.Earning[ym] || 0;
                    spends += monthlyData.Spend[ym] || 0;
                    investments += monthlyData.Investment[ym] || 0;
                }
            });
            return {
                labels: [year],
                earnings: [earnings],
                spends: [spends],
                investments: [investments],
                savings: [earnings - spends - investments]
            };
        }
        function getMonthlyChartData() {
            const months = allMonths;
            const earnings = months.map(month => monthlyData.Earning[month] || 0);
            const spends = months.map(month => monthlyData.Spend[month] || 0);
            const investments = months.map(month => monthlyData.Investment[month] || 0);
            const savings = months.map((month, i) => (monthlyData.Earning[month] || 0) - (monthlyData.Spend[month] || 0) - (monthlyData.Investment[month] || 0));
            const formattedMonths = months.map(getMonthLabel);
            return {
                labels: formattedMonths,
                earnings, spends, investments, savings
            };
        }
        function getYearlyChartData() {
            const yearlyMap = {};
            allYears.forEach(year => {
                yearlyMap[year] = {Earning: 0, Spend: 0, Investment: 0};
            });
            for (const type of ['Earning', 'Spend', 'Investment']) {
                for (const ym in monthlyData[type]) {
                    const [year, ] = ym.split('-');
                    yearlyMap[year][type] += monthlyData[type][ym] || 0;
                }
            }
            const years = allYears;
            const earnings = years.map(year => yearlyMap[year].Earning || 0);
            const spends = years.map(year => yearlyMap[year].Spend || 0);
            const investments = years.map(year => yearlyMap[year].Investment || 0);
            const savings = years.map((year, i) => (yearlyMap[year].Earning || 0) - (yearlyMap[year].Spend || 0) - (yearlyMap[year].Investment || 0));
            return {
                labels: years,
                earnings, spends, investments, savings
            };
        }

        // --- Monthly Cards Update ---
        function updateMonthlyCards(year, month) {
            const ym = year + '-' + month;
            const earning = monthlyData.Earning[ym] || 0;
            const spend = monthlyData.Spend[ym] || 0;
            const investment = monthlyData.Investment[ym] || 0;
            const savings = earning - spend - investment;
            document.getElementById('monthly-earning').textContent = '₹' + earning.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            document.getElementById('monthly-spend').textContent = '₹' + spend.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            document.getElementById('monthly-investment').textContent = '₹' + investment.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            document.getElementById('monthly-savings').textContent = '₹' + savings.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            
            // Update card headers with specific month/year
            updateCardHeaders('monthly', month, year);
        }

        // Function to update card headers with period information
        function updateCardHeaders(mode, month, year) {
            const monthName = month ? MONTH_NAMES[parseInt(month, 10) - 1] : '';
            let periodText = '';
            
            if (mode === 'monthly') {
                periodText = `${monthName} ${year}`;
            } else if (mode === 'yearly') {
                periodText = year;
            }
            
            document.querySelectorAll('#monthly-cards-row .card-title').forEach(title => {
                const type = title.textContent.split(' ')[0];
                title.textContent = `${type} (${periodText})`;
            });
        }

        let chartMode = 'monthly';
        let chartData = getMonthlyChartData();

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        const monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Earnings',
                        data: chartData.earnings,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Spends',
                        data: chartData.spends,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Investments',
                        data: chartData.investments,
                        backgroundColor: 'rgba(23, 162, 184, 0.7)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Savings',
                        data: chartData.savings,
                        type: 'line',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                        pointRadius: 4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '₹' + context.parsed.y.toLocaleString();
                                return label;
                            }
                        }
                    }
                }
            }
        });

        populateYearSelect();
        let selectedYear = allYears[allYears.length - 1];
        yearSelect.value = selectedYear;
        populateMonthSelect(selectedYear);
        let selectedMonth = monthSelect.options[monthSelect.options.length - 1]?.value || "01";
        monthSelect.value = selectedMonth;

        // Initial update for monthly cards
        updateMonthlyCards(selectedYear, selectedMonth);

        function updateDropdownVisibility() {
            if (chartMode === 'monthly') {
                monthSelect.style.display = '';
                yearSelect.style.display = '';
            } else if (chartMode === 'yearly') {
                monthSelect.style.display = 'none';
                yearSelect.style.display = '';
            } else {
                monthSelect.style.display = 'none';
                yearSelect.style.display = 'none';
            }
        }

        function toggleMonthlyCards(show) {
            const monthlyCardsRow = document.getElementById('monthly-cards-row');
            if (show) {
                monthlyCardsRow.style.display = '';
            } else {
                monthlyCardsRow.style.display = 'none';
            }
        }
        
        function updateCardLabels(period) {
            if (period === 'monthly') {
                updateCardHeaders('monthly', monthSelect.value, yearSelect.value);
            } else if (period === 'yearly') {
                updateCardHeaders('yearly', null, yearSelect.value);
            }
        }
        
        updateDropdownVisibility();
        // Initial update for card headers
        updateCardHeaders('monthly', selectedMonth, selectedYear);
        
        // Add event listener for monthSelect to update data when month changes
        monthSelect.addEventListener('change', function() {
            selectedMonth = this.value;
            if (chartMode === 'monthly') {
                const data = getSingleMonthChartData(selectedYear, selectedMonth);
                monthlyChart.data.labels = data.labels;
                monthlyChart.data.datasets[0].data = data.earnings;
                monthlyChart.data.datasets[1].data = data.spends;
                monthlyChart.data.datasets[2].data = data.investments;
                monthlyChart.data.datasets[3].data = data.savings;
                monthlyChart.update();
                updateMonthlyCards(selectedYear, selectedMonth);
            }
        });
        
        document.querySelectorAll('[data-chart-period]').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('[data-chart-period]').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                chartMode = this.dataset.chartPeriod;
                updateDropdownVisibility();

                // Show monthly cards for monthly and yearly views, hide for 'all'
                toggleMonthlyCards(chartMode !== 'all');
                
                // Update card labels based on current view
                if (chartMode !== 'all') {
                    updateCardLabels(chartMode);
                }

                if (chartMode === 'monthly') {
                    const data = getSingleMonthChartData(yearSelect.value, monthSelect.value);
                    monthlyChart.data.labels = data.labels;
                    monthlyChart.data.datasets[0].data = data.earnings;
                    monthlyChart.data.datasets[1].data = data.spends;
                    monthlyChart.data.datasets[2].data = data.investments;
                    monthlyChart.data.datasets[3].data = data.savings;
                    monthlyChart.update();
                    updateMonthlyCards(yearSelect.value, monthSelect.value);
                } else if (chartMode === 'yearly') {
                    const data = getSingleYearChartData(yearSelect.value);
                    monthlyChart.data.labels = data.labels;
                    monthlyChart.data.datasets[0].data = data.earnings;
                    monthlyChart.data.datasets[1].data = data.spends;
                    monthlyChart.data.datasets[2].data = data.investments;
                    monthlyChart.data.datasets[3].data = data.savings;
                    monthlyChart.update();
                    
                    // Update monthly cards to show yearly totals
                    const yearTotals = {
                        earning: data.earnings[0],
                        spend: data.spends[0],
                        investment: data.investments[0],
                        savings: data.savings[0]
                    };
                    
                    document.getElementById('monthly-earning').textContent = '₹' + yearTotals.earning.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                    document.getElementById('monthly-spend').textContent = '₹' + yearTotals.spend.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                    document.getElementById('monthly-investment').textContent = '₹' + yearTotals.investment.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                    document.getElementById('monthly-savings').textContent = '₹' + yearTotals.savings.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                    
                    // Update headers for yearly view
                    updateCardHeaders('yearly', null, selectedYear);
                } else {
                    const data = getMonthlyChartData();
                    monthlyChart.data.labels = data.labels;
                    monthlyChart.data.datasets[0].data = data.earnings;
                    monthlyChart.data.datasets[1].data = data.spends;
                    monthlyChart.data.datasets[2].data = data.investments;
                    monthlyChart.data.datasets[3].data = data.savings;
                    monthlyChart.update();
                }
            });
        });

        yearSelect.addEventListener('change', function() {
            selectedYear = this.value;
            populateMonthSelect(selectedYear);
            selectedMonth = monthSelect.options[monthSelect.options.length - 1]?.value || "01";
            monthSelect.value = selectedMonth;
            if (chartMode === 'monthly') {
                const data = getSingleMonthChartData(selectedYear, selectedMonth);
                monthlyChart.data.labels = data.labels;
                monthlyChart.data.datasets[0].data = data.earnings;
                monthlyChart.data.datasets[1].data = data.spends;
                monthlyChart.data.datasets[2].data = data.investments;
                monthlyChart.data.datasets[3].data = data.savings;
                monthlyChart.update();
                updateMonthlyCards(selectedYear, selectedMonth);
            } else if (chartMode === 'yearly') {
                const data = getSingleYearChartData(selectedYear);
                monthlyChart.data.labels = data.labels;
                monthlyChart.data.datasets[0].data = data.earnings;
                monthlyChart.data.datasets[1].data = data.spends;
                monthlyChart.data.datasets[2].data = data.investments;
                monthlyChart.data.datasets[3].data = data.savings;
                monthlyChart.update();
                
                // Update monthly cards with yearly data when changing year in yearly view
                const yearTotals = {
                    earning: data.earnings[0],
                    spend: data.spends[0],
                    investment: data.investments[0],
                    savings: data.savings[0]
                };
                
                document.getElementById('monthly-earning').textContent = '₹' + yearTotals.earning.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                document.getElementById('monthly-spend').textContent = '₹' + yearTotals.spend.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                document.getElementById('monthly-investment').textContent = '₹' + yearTotals.investment.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                document.getElementById('monthly-savings').textContent = '₹' + yearTotals.savings.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                
                // Update card headers when year changes in yearly view
                updateCardHeaders('yearly', null, selectedYear);
            }
        });
        
        // Also update card headers when month changes
        monthSelect.addEventListener('change', function() {
            selectedMonth = this.value;
            // Update card headers with new month
            if (chartMode === 'monthly') {
                updateCardHeaders('monthly', selectedMonth, selectedYear);
            }
            // Rest of the existing month change code
            if (chartMode === 'monthly') {
                const data = getSingleMonthChartData(selectedYear, selectedMonth);
                monthlyChart.data.labels = data.labels;
                monthlyChart.data.datasets[0].data = data.earnings;
                monthlyChart.data.datasets[1].data = data.spends;
                monthlyChart.data.datasets[2].data = data.investments;
                monthlyChart.data.datasets[3].data = data.savings;
                monthlyChart.update();
                updateMonthlyCards(selectedYear, selectedMonth);
            }
        });
    });
</script>
{% endblock %}